@page "/move_devices"
@using MySqlConnector;
@using System.Data.Common;
@inject NavigationManager NavigationManager
@inject ILocalStorageService localStorage
@inject IDialogService DialogService
@inject ISnackbar Snackbar

<AuthorizeView>
    <NotAuthorized>
        @{
            NavigationManager.NavigateTo("/");
        }
    </NotAuthorized>

    <Authorized>

            <MudDialog Style="width: 800px">
                <TitleContent>
                    <MudText Typo="Typo.h6">Geräte verschieben</MudText>
                </TitleContent>
                <DialogContent>
               
                    <MudText Class="pa-0 ma-0">Wählen Sie das zu verschiebende Gerät und anschließend die Zielgruppe aus.</MudText>

                    <MudSelect Class="mt-5" T="string" @bind-Value=target_device_name Label="Gerät" AnchorOrigin="Origin.BottomCenter">
                        @foreach (var device in device_list)
                        {
                            <MudSelectItem Value="@device" />
                        }
                    </MudSelect>

                    <MudSelect T="string" @bind-Value=target_group_name Label="Zielgruppe" AnchorOrigin="Origin.BottomCenter">
                        @foreach (var group in groups_list)
                        {
                            <MudSelectItem Value="@group" />
                        }
                    </MudSelect>

                </DialogContent>

                <DialogActions>
                    <MudButton Size="Size.Small" OnClick="Cancel">Abbrechen</MudButton>
                <MudButton Size="Size.Small" OnClick="Move_Device" Variant="@Variant.Filled" Color="@Color.Success">Verschieben</MudButton>
            </DialogActions>
            </MudDialog>

        </Authorized>
    </AuthorizeView>

@code {

    private string target_device_name = null;
    private string target_group_name = null;
    private List<string> device_list = new List<string> { };
    private List<string> groups_list = new List<string> { };

    [CascadingParameter]
    private MudDialogInstance MudDialog { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        await Get_Devices();
        await Get_Groups();
        StateHasChanged();
    }

    private async Task Get_Devices()
    {
        string tenant_name = await localStorage.GetItemAsync<string>("tenant_name");
        string group_name = await localStorage.GetItemAsync<string>("group_name");

        string query = "SELECT * FROM devices WHERE authorized = '1' AND group_name = @group_name AND tenant_name = @tenant_name;";

        MySqlConnection conn = new MySqlConnection(Application_Settings.connectionString);

        try
        {
            await conn.OpenAsync();

            MySqlCommand command = new MySqlCommand(query, conn);
            command.Parameters.AddWithValue("@tenant_name", tenant_name);
            command.Parameters.AddWithValue("@group_name", group_name);

            using (DbDataReader reader = await command.ExecuteReaderAsync())
            {
                if (reader.HasRows)
                {
                    while (await reader.ReadAsync())
                        device_list.Add(reader["device_name"].ToString() ?? "");
                }
            }
        }
        catch (Exception ex)
        {
            Logging.Handler.Error("class", "Get_Devices", ex.Message);
        }
        finally
        {
            conn.Close();
        }
    }

    private async Task Get_Groups()
    {
        string tenant_name = await localStorage.GetItemAsync<string>("tenant_name");
        string location_name = await localStorage.GetItemAsync<string>("location_name");

        string query = "SELECT * FROM `groups` WHERE location_name = @location_name AND tenant_name = @tenant_name;";

        MySqlConnection conn = new MySqlConnection(Application_Settings.connectionString);

        try
        {
            await conn.OpenAsync();

            MySqlCommand command = new MySqlCommand(query, conn);
            command.Parameters.AddWithValue("@tenant_name", tenant_name);
            command.Parameters.AddWithValue("@location_name", location_name);

            using (DbDataReader reader = await command.ExecuteReaderAsync())
            {
                if (reader.HasRows)
                {
                    while (await reader.ReadAsync())
                        groups_list.Add(reader["name"].ToString() ?? "");
                }
            }

        }
        catch (Exception ex)
        {
            Logging.Handler.Error("class", "Get_Groups", ex.Message);
        }
        finally
        {
            conn.Close();
        }
    }

    private async Task Move_Device()
    {
        string tenant_name = await localStorage.GetItemAsync<string>("tenant_name");

        this.Snackbar.Configuration.ShowCloseIcon = true;
        this.Snackbar.Configuration.PositionClass = Defaults.Classes.Position.BottomRight;

        if (String.IsNullOrEmpty(target_group_name) || String.IsNullOrEmpty(target_device_name))
            this.Snackbar.Add("Ungültige Eingabe.", Severity.Error);
        else
        {
            bool success = false;

            MySqlConnection conn = new MySqlConnection(Application_Settings.connectionString);

            try
            {
                await conn.OpenAsync();

                string execute_query = "UPDATE devices SET group_name = @group_name WHERE device_name = @device_name AND tenant_name = @tenant_name;";

                MySqlCommand cmd = new MySqlCommand(execute_query, conn);
                cmd.Parameters.AddWithValue("@tenant_name", tenant_name);
                cmd.Parameters.AddWithValue("@group_name", target_group_name);
                cmd.Parameters.AddWithValue("@device_name", target_device_name);
                cmd.ExecuteNonQuery();

                success = true;
            }
            catch (Exception ex)
            {
                Logging.Handler.Error("/location_settings -> Add_Policy_Dialog.OK", "Result", ex.Message);
            }
            finally
            {
                await conn.CloseAsync();
            }

            if (success)
            {
                this.Snackbar.Add("Gerät verschoben.", Severity.Success);
                this.MudDialog.Close(DialogResult.Ok("success"));
            }
            else
            {
                this.Snackbar.Add("Verschieben fehlgeschlagen.", Severity.Error);
                this.MudDialog.Close(DialogResult.Ok("error"));
            }
        }  
    }

    private void Cancel() => MudDialog.Cancel();

    private void Redirect(string path)
    {        
        NavigationManager.NavigateTo(Application_Paths.redirect_path);
        NavigationManager.NavigateTo(path);
    }

}
