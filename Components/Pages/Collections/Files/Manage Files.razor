@page "/manage_files"

@using MySqlConnector;
@using System.Data.Common;
@using System.Text.Json;
@using System.Text.Json.Nodes;
@using OfficeOpenXml;
@using System.Xml.Serialization;
@using System.Text;
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage;
@using Microsoft.AspNetCore.DataProtection;
@using System.Net;
@using System.Net.Http;
@using System.Net.Http.Headers;
@using NetLock_RMM_Web_Console.Configuration;

@inject NavigationManager NavigationManager
@inject ILocalStorageService localStorage
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject IJSRuntime JSRuntime
@inject IDataProtectionProvider DataProtectionProvider
@inject IStringLocalizer<Pages.Collections.Files.Manage_Files> Localizer

<style>
    .selected-row-light {
        background-color: lightgray;
    }

    .selected-row-dark {
        background-color: #141414;
    }

    .custom-expansion-panel {
        background-color: transparent;
    }

    .dialog-blurring {
        backdrop-filter: blur(10px);
    }

    .mud-table-cell-custom-group {
        font-weight: 500;
    }

    .mud-table-cell-custom-group-footer {
        padding-bottom: 50px;
        text-align: right;
    }

    @@media only screen and (max-width: 768px) {
        .desktop-icon {
            display: none;
        }
    }
</style>

<AuthorizeView>
    <NotAuthorized>
        @{
            NavigationManager.NavigateTo("/");
        }
    </NotAuthorized>

    <Authorized>
        
        @if (permissions_collections_enabled && permissions_collections_files_enabled)
        {
            <MudText Typo="Typo.h5">@Localizer["title"]</MudText>

            @if (permissions_collections_files_add)
            {
                <MudButton Class="mt-5" Size="Size.Small" Variant="Variant.Filled" OnClick="@Add_File_Dialog" Color="Color.Default" StartIcon="@Icons.Material.Filled.Refresh">@Localizer["refresh"]</MudButton>
                <MudButton Class="mt-5" Size="Size.Small" Variant="Variant.Filled" OnClick="@Add_File_Dialog" Color="Color.Default" StartIcon="@Icons.Material.Filled.CreateNewFolder">@Localizer["add_folder"]</MudButton>
                <MudButton Class="mt-5" Size="Size.Small" Variant="Variant.Filled" OnClick="@Add_File_Dialog" Color="Color.Default" StartIcon="@Icons.Material.Filled.UploadFile">@Localizer["add_file"]</MudButton>
            }

            <MudPaper Class="mt-5">

            <MudTable Class="mt-2" Height="25vh" FixedHeader="true" FixedFooter="true" Hover="true" RowsPerPage="int.MaxValue" Dense="true" Items="@files_mysql_data" Filter="new Func<Files_Entity, bool>(Files_Table_Filter_Func)">
                <ToolBarContent>
                        <MudTextField Class="" Placeholder="-" Adornment="Adornment.Start" IconSize="Size.Medium" AdornmentIcon="@Icons.Material.Filled.Link" @bind-Value="files_selected_path" OnKeyDown="Remote_File_Browser_Path_Keyboard_Enter" Immediate="true"></MudTextField>
                    <MudTextField Class="ml-2" @bind-Value="files_table_search_string" Placeholder="@Localizer["search"]" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium"></MudTextField>
                </ToolBarContent>
                <HeaderContent>
                    <MudTh Sortable="true" @onclick="() => files_table_sorted_column = (nameof(Files_Entity.name))" style="white-space: nowrap;">Name</MudTh>
                    <MudTh Sortable="true" @onclick="() => files_table_sorted_column = (nameof(Files_Entity.last_modified))" style="white-space: nowrap;">@Localizer["modification_date"]</MudTh>
                        <MudTh Sortable="true" @onclick="() => files_table_sorted_column = (nameof(Files_Entity.type))" style="white-space: nowrap;">@Localizer["type"]</MudTh>
                        <MudTh Sortable="true" @onclick="() => files_table_sorted_column = (nameof(Files_Entity.size))" style="white-space: nowrap;">@Localizer["size_gb"]</MudTh>
                </HeaderContent>
                <RowTemplate Context="files_row">

                        <MudTd DataLabel="Name" @ondblclick="() => Files_RowClickHandler(files_row)" class="@Files_GetRowClass(files_row)" style="white-space: nowrap;">
                        <MudMenu ActivationEvent="@MudBlazor.MouseEvent.RightClick" Dense="true">
                            <ActivatorContent>
                                <span style="display: flex; align-items: center;">
                                    &nbsp;@files_row.name
                                </span>
                            </ActivatorContent>
                            <ChildContent>
                                @{
                                    if (files_row.type == "Directory")
                                    {
                                        //<MudMenuItem @onclick="async () => { await Remote_File_Browser_Delete_Directory(files_row.path); }">@Localizer["delete"]</MudMenuItem>
                                        //<MudMenuItem @onclick="async () => { await Remote_File_Browser_Move_Directory_Dialog(files_row.path); }">@Localizer["move"]</MudMenuItem>
                                        //<MudMenuItem @onclick="async () => { await Remote_File_Browser_Rename_Directory_Dialog(files_row.path); }">@Localizer["rename"]</MudMenuItem>
                                    }
                                    else
                                    {
                                        //<MudMenuItem @onclick="async () => { await Remote_File_Browser_Delete_File(files_row.path); }">@Localizer["delete"]</MudMenuItem>
                                        //<MudMenuItem @onclick="async () => { await Remote_File_Browser_Move_File_Dialog(files_row.path); }">@Localizer["move"]</MudMenuItem>
                                        //<MudMenuItem @onclick="async () => { await Remote_File_Browser_Rename_File_Dialog(files_row.path); }">@Localizer["rename"]</MudMenuItem>
                                    }
                                }

                            </ChildContent>
                        </MudMenu>

                    </MudTd>

                        <MudTd DataLabel="@Localizer["modification_date"]" @ondblclick="() => Files_RowClickHandler(files_row)" class="@Files_GetRowClass(files_row)" style="white-space: nowrap;">
                        <span style="display: flex; align-items: center;">
                            &nbsp;@files_row.last_modified
                        </span>
                    </MudTd>

                        <MudTd DataLabel="@Localizer["type"]" @ondblclick="() => Files_RowClickHandler(files_row)" class="@Files_GetRowClass(files_row)" style="white-space: nowrap;">
                        <span style="display: flex; align-items: center;">
                            &nbsp;@files_row.type
                        </span>
                    </MudTd>

                        <MudTd DataLabel="@Localizer["size_gb"]" @ondblclick="() => Files_RowClickHandler(files_row)" class="@Files_GetRowClass(files_row)" style="white-space: nowrap;">
                        <span style="display: flex; align-items: center;">
                            &nbsp;@files_row.size
                        </span>
                    </MudTd>

                </RowTemplate>
                <PagerContent>
                    <MudTablePager PageSizeOptions="new int[] { 10, 25, 50, 100, 250, 500, int.MaxValue }" RowsPerPageString="@Localizer["rows_per_page"]" />
                </PagerContent>
            </MudTable>

            </MudPaper>
        }

    </Authorized>
 </AuthorizeView>

@code {

    #region Permissions System

    private string permissions_json = String.Empty;
    private string permissions_tenants_json = String.Empty;
    public static List<string> permissions_tenants_list = new List<string> { };

    private bool permissions_collections_enabled = false;
    private bool permissions_collections_files_enabled = false;
    private bool permissions_collections_files_add = false;
    private bool permissions_collections_files_edit = false;
    private bool permissions_collections_files_delete = false;

    public class Permissions_Tenants_Activation_State
    {
        public string id { get; set; } = String.Empty;
    }

    private async Task Get_Permissions()
    {
        //Extract user info from users session storage
        var sessionStorage = new ProtectedSessionStorage(JSRuntime, DataProtectionProvider);
        var username = await sessionStorage.GetAsync<string>("username");
        var password = await sessionStorage.GetAsync<string>("password");

        Logging.Handler.Debug("/manage_files -> Permissions_Load", "username", username.Value ?? String.Empty);

        //if user info empty, force logout
        if (String.IsNullOrEmpty(username.Value) || String.IsNullOrEmpty(password.Value))
        {
            Logging.Handler.Debug("/manage_files -> Permissions_Load", "sessions storage data", "empty, force logout");

            NavigationManager.NavigateTo("/logout", true);
            return;
        }

        //Check if user info is valid, if not, force logout
        if (!await Classes.Authentication.User.Verify_User(username.Value ?? String.Empty, password.Value ?? String.Empty))
        {
            Logging.Handler.Debug("/manage_files -> Permissions_Load", "verify user", "incorrect data, force logout");

            NavigationManager.NavigateTo("/logout", true);
            return;
        }

        //Get permissions
        string query = "SELECT * FROM `accounts` WHERE username = @username;";

        MySqlConnection conn = new MySqlConnection(Configuration.MySQL.Connection_String);

        try
        {
            await conn.OpenAsync();

            MySqlCommand command = new MySqlCommand(query, conn);
            command.Parameters.AddWithValue("@username", username.Value);

            Logging.Handler.Debug("/manage_files -> Permissions_Load", "query", query);

            using (DbDataReader reader = await command.ExecuteReaderAsync())
            {
                if (reader.HasRows)
                {
                    while (await reader.ReadAsync())
                    {
                        permissions_json = reader["permissions"].ToString() ?? String.Empty;
                        permissions_tenants_json = reader["tenants"].ToString() ?? String.Empty;
                    }
                }
            }

            Logging.Handler.Debug("/manage_files -> Permissions_Load", "permissions_json", permissions_json);

            //Extract permissions
            if (!String.IsNullOrEmpty(permissions_json))
            {
                using (JsonDocument document = JsonDocument.Parse(permissions_json))
                {
                    //collections_enabled
                    try
                    {
                        JsonElement element = document.RootElement.GetProperty("collections_enabled");
                        permissions_collections_enabled = element.GetBoolean();
                    }
                    catch (Exception ex)
                    {
                        Logging.Handler.Error("/manage_files -> Permissions_Load", "permissions_json (collections_enabled)", ex.Message);
                    }

                    //collections_files_enabled
                    try
                    {
                        JsonElement element = document.RootElement.GetProperty("collections_files_enabled");
                        permissions_collections_files_enabled = element.GetBoolean();
                    }
                    catch (Exception ex)
                    {
                        Logging.Handler.Error("/manage_files -> Permissions_Load", "permissions_json (collections_files_enabled)", ex.Message);
                    }

                    //collections_files_add
                    try
                    {
                        JsonElement element = document.RootElement.GetProperty("collections_files_add");
                        permissions_collections_files_add = element.GetBoolean();
                    }
                    catch (Exception ex)
                    {
                        Logging.Handler.Error("/manage_files -> Permissions_Load", "permissions_json (collections_files_add)", ex.Message);
                    }

                    //collections_files_edit
                    try
                    {
                        JsonElement element = document.RootElement.GetProperty("collections_files_edit");
                        permissions_collections_files_edit = element.GetBoolean();
                    }
                    catch (Exception ex)
                    {
                        Logging.Handler.Error("/manage_files -> Permissions_Load", "permissions_json (collections_files_edit)", ex.Message);
                    }

                    //collections_files_delete
                    try
                    {
                        JsonElement element = document.RootElement.GetProperty("collections_files_delete");
                        permissions_collections_files_delete = element.GetBoolean();
                    }
                    catch (Exception ex)
                    {
                        Logging.Handler.Error("/manage_files -> Permissions_Load", "permissions_json (collections_files_delete)", ex.Message);
                    }
                }
            }
            else if (permissions_json == "[]")
            {
                Logging.Handler.Debug("/manage_files -> Permissions_Load", "permissions_json", "Empty, logout user");
                NavigationManager.NavigateTo("/logout", true);
            }
            else
            {
                Logging.Handler.Debug("/manage_files -> Permissions_Load", "permissions_json", "Empty, logout user");
                NavigationManager.NavigateTo("/logout", true);
            }

            //Extract tenants from json
            permissions_tenants_list.Clear();
            if (!String.IsNullOrEmpty(permissions_tenants_json))
            {
                //Set the activation state for the tenants
                try
                {
                    List<Permissions_Tenants_Activation_State> tenants_activation_state_list = JsonSerializer.Deserialize<List<Permissions_Tenants_Activation_State>>(permissions_tenants_json);

                    foreach (var tenant in tenants_activation_state_list)
                    {
                        Logging.Handler.Debug("/manage_files -> Permissions_Load", "foreach tenant", tenant.id);

                        permissions_tenants_list.Add(tenant.id);
                    }
                }
                catch (Exception ex)
                {
                    Logging.Handler.Error("/manage_files -> Permissions_Load (permissions_tenants_json deserialize)", "Result", ex.Message);
                }
            }
            else
            {
                Logging.Handler.Debug("/manage_files -> Permissions_Load (permissions_tenants_json deserialize)", "Result", "Empty");
            }
        }
        catch (Exception ex)
        {
            Logging.Handler.Error("/manage_files -> Permissions_Load", "general_error (force logout)", ex.Message);
            NavigationManager.NavigateTo("/logout", true);
        }
        finally
        {
            conn.Close();
        }
    }

    #endregion

    private bool _isDarkMode = false;

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await AfterInitializedAsync();
        }
    }

    private async Task AfterInitializedAsync()
    {
        await Get_Permissions();
        //Check permissions
        if (!permissions_collections_enabled || !permissions_collections_files_enabled)
        {
            NavigationManager.NavigateTo("/logout", true);
            return;
        }

        _isDarkMode = await JSRuntime.InvokeAsync<bool>("isDarkMode");

        await Get_Files(true);

        StateHasChanged();
    }

    private string files_json = String.Empty;

    private async Task Get_Files(bool base_path)
    {
        // Get api key from settings table
        string api_key = await Classes.MySQL.Handler.Quick_Reader("SELECT * FROM settings;", "files_api_key");

        // Get NetLock Remote Server from appsettings.json

        // Create a HttpClient instance
        using (var httpClient = new HttpClient())
        {
            // Set the content type header
            httpClient.DefaultRequestHeaders.Accept.Add(new MediaTypeWithQualityHeaderValue("application/json"));
            httpClient.DefaultRequestHeaders.Add("Api-Key", api_key);

            //Logging.Handler.Debug("/manage_files", "Get_Files", Service.http_https + Service.communication_server + "/Agent/Windows/Policy");

            // Send the JSON data to the server
            //var response = await httpClient.PostAsync(Service.http_https + Service.communication_server + "/Agent/Windows/Policy", new StringContent(json, Encoding.UTF8, "application/json"));

            /*
            // Check if the request was successful
            if (response.IsSuccessStatusCode)
            {
                // Request was successful, handle the response
                var result = await response.Content.ReadAsStringAsync();
                Logging.Handler.Debug("Online_Mode.Handler.Policy", "result", result);

                if (result == "unauthorized")
                {

                }
            }
            */
        }
        //files_mysql_data = new List<Files_Entity>();


        /*
        Files_Entity entity = new Files_Entity //Create entity
            {
                id = reader["id"].ToString() ?? String.Empty,
                name = reader["name"].ToString() ?? String.Empty,
                description = reader["description"].ToString() ?? String.Empty,
                author = reader["author"].ToString() ?? String.Empty,
                date = reader["date"].ToString() ?? String.Empty,
                platform = reader["platform"].ToString() ?? String.Empty,
                type = reader["type"].ToString() ?? String.Empty,
                file_json = reader["json"].ToString() ?? String.Empty,
            };
        */
    }

    private async Task Remote_File_Browser_Path_Keyboard_Enter(KeyboardEventArgs e)
    {
        //if (e.Key == "Enter" && !String.IsNullOrEmpty(remote_file_browser_path))
            //await Remote_File_Browser_Get_Index(remote_file_browser_path, false);
    }

    private string files_selected_path = String.Empty;
    private List<string> file_selected_old_paths_list = new List<string> { };

    public List<Files_Entity> files_mysql_data;

    public class Files_Entity
    {
        public string id { get; set; } = String.Empty;
        public string name { get; set; } = String.Empty;
        public string path { get; set; } = String.Empty;
        public string type { get; set; } = String.Empty;
        public string size { get; set; } = String.Empty;
        public string last_modified { get; set; } = String.Empty;
    }

    private string files_table_view_port = "70vh";
    private string files_table_sorted_column;
    private string files_table_search_string = "";

    private bool Files_Table_Filter_Func(Files_Entity row)
    { 
        if (string.IsNullOrEmpty(files_table_search_string))
            return true;

        //Search logic for each column
        return row.name.Contains(files_table_search_string, StringComparison.OrdinalIgnoreCase) ||
            row.path.Contains(files_table_search_string, StringComparison.OrdinalIgnoreCase) ||
            row.type.Contains(files_table_search_string, StringComparison.OrdinalIgnoreCase) ||
            row.size.Contains(files_table_search_string, StringComparison.OrdinalIgnoreCase) ||
            row.last_modified.Contains(files_table_search_string, StringComparison.OrdinalIgnoreCase);
    }

    private string files_selectedRowContent_id = String.Empty; // Hier wird der Inhalt der ausgewählten Zeile gespeichert

    private void Files_RowClickHandler(Files_Entity row)
    {
        files_selectedRowContent_id = row.id;
    }

    private async void Files_RowDblClickHandler(Files_Entity row)
    {
     
    }

    private string Files_GetRowClass(Files_Entity row)
    {
        return row.id == files_selectedRowContent_id ? (_isDarkMode ? "selected-row-dark" : "selected-row-light") : String.Empty;
    }

    private bool Files_Get_Row_Selected()
    {
        if (String.IsNullOrEmpty(files_selectedRowContent_id) == false)
            return false;
        else
            return true;
    }

    bool add_file_dialog_open = false;

    private async Task Add_File_Dialog()
    {
        if (add_file_dialog_open)
            return;

        var options = new DialogOptions
        {
            CloseButton = true,
            FullWidth = true,
            MaxWidth = MaxWidth.Medium,
            BackgroundClass = "dialog-blurring",
        };

        add_file_dialog_open = true;

        var result = await this.DialogService.Show<Pages.Collections.Jobs.Dialogs.Add_Job_Dialog>(string.Empty, new DialogParameters(), options).Result;

        add_file_dialog_open = false;

        if (result.Canceled)
            return;

        Logging.Handler.Debug("/manage_files -> Add_File_Dialog", "Result", result.Data.ToString());

        if (String.IsNullOrEmpty(result.Data.ToString()) == false && result.Data.ToString() != "error")
        {
            files_json = result.Data.ToString();

            await Get_Files(false);
        }
    }

    private bool edit_file_dialog_open = false;

    private async Task Edit_File_Dialog(string id, string json)
    {
        if (edit_file_dialog_open)
            return;

        var options = new DialogOptions
            {
                CloseButton = true,
                FullWidth = true,
                MaxWidth = MaxWidth.Medium,
                BackgroundClass = "dialog-blurring",
            };

        DialogParameters parameters = new DialogParameters();
        parameters.Add("id", id);
        parameters.Add("json", json);

        edit_file_dialog_open = true;

        var result = await this.DialogService.Show<Pages.Collections.Jobs.Dialogs.Edit_Job_Dialog>(string.Empty, parameters, options).Result;

        edit_file_dialog_open = false;

        if (result.Canceled)
            return;

        Logging.Handler.Debug("/manage_files -> Edit_File_Dialog", "Result", result.Data.ToString());

        if (String.IsNullOrEmpty(result.Data.ToString()) == false && result.Data.ToString() != "error")
        {
            files_json = result.Data.ToString();

            files_selectedRowContent_id = String.Empty;

            await Get_Files(false);
        }
    }

    private bool delete_file_dialog_open = false;

    private async Task Delete_File_Dialog(string id)
    {
        if (delete_file_dialog_open)
            return;

        var options = new DialogOptions
            {
                CloseButton = true,
                FullWidth = true,
                MaxWidth = MaxWidth.Small,
                BackgroundClass = "dialog-blurring",
            };
            
        DialogParameters parameters = new DialogParameters();
        parameters.Add("id", id);

        delete_file_dialog_open = true;

        var result = await this.DialogService.Show<Pages.Collections.Jobs.Dialogs.Delete_Job_Dialog>(string.Empty, parameters, options).Result;

        delete_file_dialog_open = false;

        if (result.Canceled)
            return;

        Logging.Handler.Debug("/manage_files -> Delete_File_Dialog", "Result", result.Data.ToString());

        if (String.IsNullOrEmpty(result.Data.ToString()) == false && result.Data.ToString() != "error")
        {
            files_json = result.Data.ToString();

            files_selectedRowContent_id = String.Empty;

            await Get_Files(false);
        }
    }

    #region Data_Export
    private async Task Trigger_Export_Table_Dialog()
    {
        await Export_Table_Dialog("files");
    }

    private async Task Export_Table_Dialog(string type)
    {
        var options = new DialogOptions
            {
                CloseButton = true,
                FullWidth = true,
                MaxWidth = MaxWidth.Small,
                BackgroundClass = "dialog-blurring",
            };

        var result = await this.DialogService.Show<Shared.Export_Data_Dialog>(string.Empty, new DialogParameters(), options).Result;

        if (result != null && result.Data != null)
        {
            if (result.Data.ToString() == "JSON")
                await Export_Data_Json(type);
            else if (result.Data.ToString() == "Spreadsheet (.xlsx)")
                await Export_Data_Spreadsheet(type);
            else if (result.Data.ToString() == "HTML")
                await Export_Data_HTML(type);
        }
    }

    private async Task Export_Data_Json(string type)
    {
        try
        {
            string jsonContent = String.Empty;

            // Erstellen eines JSON-Strings aus den MudTable-Einträgen
            if (type == "files")
                jsonContent = JsonSerializer.Serialize(files_mysql_data, new JsonSerializerOptions { WriteIndented = true });

            // Aufruf der JavaFile-Funktion für den Export als .txt
            await JSRuntime.InvokeVoidAsync("exportToTxt", $"{type}.json", jsonContent);
        }
        catch (Exception ex)
        {
            Logging.Handler.Error("/manage_files -> Export_Data_Json", "", ex.Message);
        }
    }

    public async Task Export_Data_HTML(string type)
    {
        try
        {
            StringBuilder htmlBuilder = new StringBuilder();

            if (type == "files")
            {
                // Baue den Tabellenkopf basierend auf den Eigenschaften der Datenklasse
                htmlBuilder.Append("<table border='1'><tr>");
                foreach (var property in files_mysql_data.First().GetType().GetProperties())
                {
                    htmlBuilder.Append($"<th>{property.Name}</th>");
                }
                htmlBuilder.Append("</tr>");

                // Baue die Tabelleneinträge basierend auf den Daten
                foreach (var entry in files_mysql_data)
                {
                    htmlBuilder.Append("<tr>");
                    foreach (var property in entry.GetType().GetProperties())
                    {
                        htmlBuilder.Append($"<td>{property.GetValue(entry)}</td>");
                    }
                    htmlBuilder.Append("</tr>");
                }
            }

            htmlBuilder.Append("</table>");

            string htmlContent = htmlBuilder.ToString();

            // Hier wird JavaFile-Interop verwendet, um den HTML-Inhalt herunterzuladen
            await JSRuntime.InvokeVoidAsync("exportToTxt", $"{type}.html", htmlContent, "text/html");
        }
        catch (Exception ex)
        {
            Logging.Handler.Error("/manage_files -> Export_Data_HTML", "", ex.Message);
        }
    }

    private async Task Export_Data_Spreadsheet(string type)
    {
        try
        {
            using (var package = new ExcelPackage())
            {
                var worksheet = package.Workbook.Worksheets.Add("Sheet1");

                if (type == "files")
                {
                    if (files_mysql_data.Count > 0)
                    {
                        int headerRow = 1;

                        // Baue den Tabellenkopf basierend auf den Eigenschaften der Datenklasse
                        int columnIndex = 1;
                        foreach (var property in files_mysql_data.First().GetType().GetProperties())
                        {
                            worksheet.Cells[headerRow, columnIndex].Value = property.Name;
                            columnIndex++;
                        }

                        int dataRow = headerRow + 1;

                        // Baue die Tabelleneinträge basierend auf den Daten
                        foreach (var entry in files_mysql_data)
                        {
                            columnIndex = 1;
                            foreach (var property in entry.GetType().GetProperties())
                            {
                                worksheet.Cells[dataRow, columnIndex].Value = property.GetValue(entry);
                                columnIndex++;
                            }

                            dataRow++;
                        }
                    }
                }

                var stream = new MemoryStream(package.GetAsByteArray());

                // Hier wird JavaFile-Interop verwendet, um die Datei herunterzuladen
                await JSRuntime.InvokeVoidAsync("saveAsSpreadSheet", $"{type}.xlsx", Convert.ToBase64String(stream.ToArray()));
            }
        }
        catch (Exception ex)
        {
            Logging.Handler.Error("/manage_files -> Export_Data_Spreadsheet", "", ex.Message);
        }
    }
    #endregion
}